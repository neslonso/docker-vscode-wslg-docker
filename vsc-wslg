#!/usr/bin/env bash
set -e

########################################################################################################################
# Functions

check_running_instances() {
	# Search for running vsc_* containers (excluding current one)
	local running=$(docker ps --filter "name=vsc_" --format "{{.Names}}\t{{.Image}}\t{{.Label \"com.docker.compose.project.working_dir\"}}" 2>/dev/null | grep -v "^${proj_name}_")

	if [ -z "$running" ]; then
		return 0  # No instances, continue
	fi

	# There are instance(s) running
	local reset='\033[0m'
	local yellow='\033[33m'
	local cyan='\033[36m'
	local white='\033[97m'
	local green='\033[32m'

	echo "" >&2
	echo -e "${yellow}âš ï¸  There's already a vsc-wslg instance running:${reset}" >&2
	echo "" >&2

	# Show details of each instance
	while IFS=$'\t' read -r container image workdir; do
		local project_name="${container%_vscode_*}"
		local mode_type="DooD"
		if echo "$image" | grep -q "dind"; then
			mode_type="DinD"
		fi
		echo -e "   ${white}Project:${reset}    $project_name (${mode_type})" >&2
		echo -e "   ${white}Container:${reset}  $container" >&2
		[ -n "$workdir" ] && echo -e "   ${white}Workspace:${reset}  $workdir" >&2
		echo "" >&2
	done <<< "$running"

	echo -e "${white}What do you want to do?${reset}" >&2
	echo -e "  ${green}1)${reset} Cancel (keep existing instance)" >&2
	echo -e "  ${green}2)${reset} Close existing instance and open this one" >&2
	echo "" >&2

	read -p "Option [1-2]: " choice

	case "$choice" in
		1)
			echo -e "${cyan}âœ“${reset} Operation cancelled" >&2
			exit 0
			;;
		2)
			echo -e "${cyan}ðŸ›‘${reset} Closing existing instance(s)..." >&2
			# Stop all vsc_* instances
			while IFS=$'\t' read -r container _rest; do
				# Get COMPOSE_PROJECT_NAME from container label
				local project=$(docker inspect "$container" --format='{{index .Config.Labels "com.docker.compose.project"}}' 2>/dev/null)

				# Fallback to parsing if no label
				if [ -z "$project" ]; then
					project="${container%[-_]vscode[-_]*}"
				fi

				echo "   ðŸ” DEBUG: Container name: $container" >&2
				echo "   ðŸ” DEBUG: Extracted project: $project" >&2

				# Determine mode and compose file
				local existing_mode="dood"
				local image_name=$(docker inspect "$container" --format='{{.Config.Image}}' 2>/dev/null)
				echo "   ðŸ” DEBUG: Image: $image_name" >&2

				if echo "$image_name" | grep -q "dind"; then
					existing_mode="dind"
				fi
				echo "   ðŸ” DEBUG: Mode: $existing_mode" >&2

				local base_compose="$script_dir/docker/docker-compose.yml"
				local mode_compose="$script_dir/docker/docker-compose.${existing_mode}.yml"
				echo "   ðŸ” DEBUG: Compose files: $base_compose + $mode_compose" >&2
				echo "   ðŸ” DEBUG: Running: COMPOSE_PROJECT_NAME=$project docker compose -f $base_compose -f $mode_compose down" >&2

				# Stop using the correct compose files
				COMPOSE_PROJECT_NAME="$project" docker compose -f "$base_compose" -f "$mode_compose" down 2>&1 | sed 's/^/      /'
				local exit_code=$?
				echo "   ðŸ” DEBUG: Exit code: $exit_code" >&2
			done <<< "$running"
			echo -e "${green}âœ“${reset} Done, proceeding to open new instance..." >&2
			echo "" >&2
			return 0  # Continue with up
			;;
		*)
			echo -e "${yellow}âœ—${reset} Invalid option, cancelling" >&2
			exit 1
			;;
	esac
}

show_info() {
	local reset='\033[0m'
	local cyan='\033[36m'
	local yellow='\033[33m'
	local green='\033[32m'
	local magenta='\033[35m'
	local white='\033[97m'
	local profile_arg="$1"

	# If a profile name is provided, show its README
	if [ -n "$profile_arg" ]; then
		local profile_readme="$script_dir/profiles/$profile_arg/README.md"

		if [ ! -d "$script_dir/profiles/$profile_arg" ]; then
			echo "" >&2
			echo -e "${yellow}âœ—${reset} Profile '${magenta}${profile_arg}${reset}' not found" >&2
			echo "" >&2
			echo -e "${white}Available profiles:${reset}" >&2
			for dir in "$script_dir"/profiles/*/; do
				if [ -d "$dir" ]; then
					profile_name=$(basename "$dir")
					echo -e "  ${magenta}${profile_name}${reset}" >&2
				fi
			done
			echo "" >&2
			exit 1
		fi

		if [ ! -f "$profile_readme" ]; then
			echo "" >&2
			echo -e "${yellow}âš ${reset}  Profile '${magenta}${profile_arg}${reset}' has no README.md" >&2
			echo "" >&2
			exit 1
		fi

		# Show README using less with colors
		less -R "$profile_readme"
		exit 0
	fi

	# No profile specified: list all profiles with descriptions
	echo "" >&2
	echo -e "${white}Available Development Profiles${reset}" >&2
	echo -e "${white}==============================${reset}" >&2
	echo "" >&2

	for dir in "$script_dir"/profiles/*/; do
		if [ -d "$dir" ]; then
			profile_name=$(basename "$dir")
			readme_file="$dir/README.md"

			# Extract first line description from README if it exists
			local description=""
			if [ -f "$readme_file" ]; then
				# Get the first non-empty, non-heading line after the title
				description=$(grep -m 1 "^[^#]" "$readme_file" | sed 's/^[[:space:]]*//' | head -c 80)
				if [ -z "$description" ]; then
					description="No description available"
				fi
			else
				description="No documentation available"
			fi

			echo -e "${magenta}${profile_name}${reset}" >&2
			echo -e "  ${description}..." >&2
			echo "" >&2
		fi
	done

	echo -e "${white}Usage:${reset}" >&2
	echo -e "  ${cyan}$0 info <profile>${reset}  - Show detailed profile documentation" >&2
	echo -e "  ${cyan}$0 up <profile>${reset}    - Launch VSCode with profile" >&2
	echo "" >&2
	exit 0
}

show_help() {
	local reset='\033[0m'
	local cyan='\033[36m'
	local yellow='\033[33m'
	local green='\033[32m'
	local magenta='\033[35m'
	local white='\033[97m'

	echo "" >&2
	echo -e "${white}Usage:${reset} ${cyan}$0${reset} <action> [profile] [mode]" >&2
	echo "" >&2
	echo -e "Containerized VSCode launcher displayed via ${white}WSLg${reset}." >&2
	echo -e "Run from the directory you want to mount." >&2
	echo -e "The directory will be mounted at ${yellow}/<directory-name>${reset} inside the container." >&2
	echo "" >&2
	echo -e "${white}Actions:${reset}" >&2
	echo -e "  ${green}info${reset}       List profiles or show profile details" >&2
	echo -e "  ${green}up${reset}         Launch VSCode (foreground, down on close)" >&2
	echo -e "  ${green}upd${reset}        Launch VSCode (background)" >&2
	echo -e "  ${green}upd-logs${reset}   Launch VSCode (background + logs)" >&2
	echo -e "  ${green}build${reset}      Rebuild the image" >&2
	echo -e "  ${green}down${reset}       Stop container (auto-detects mode)" >&2
	echo -e "  ${green}clean${reset}      Stop container and remove volumes (auto-detects mode)" >&2
	echo "" >&2
	echo -e "${white}Modes:${reset}" >&2
	echo -e "  ${magenta}dind${reset}  â†’ Docker-in-Docker (default)" >&2
	echo -e "  ${magenta}dood${reset}  â†’ Docker-out-of-Docker" >&2
	echo "" >&2
	echo -e "${white}Examples:${reset}" >&2
	echo -e "  ${cyan}$0${reset} ${green}info${reset}                   ${white}# List available profiles${reset}" >&2
	echo -e "  ${cyan}$0${reset} ${green}info${reset} python            ${white}# Show python profile details${reset}" >&2
	echo -e "  ${cyan}$0${reset} ${green}up${reset} python              ${white}# Launch python profile in dind${reset}" >&2
	echo -e "  ${cyan}$0${reset} ${green}up${reset} rust dood           ${white}# Launch rust in dood mode${reset}" >&2
	echo -e "  ${cyan}$0${reset} ${green}up${reset}                     ${white}# Launch without profile${reset}" >&2
	echo -e "  ${cyan}$0${reset} ${green}build${reset} python           ${white}# Rebuild python image${reset}" >&2
	echo -e "  ${cyan}$0${reset} ${green}down${reset}                   ${white}# Stop running container${reset}" >&2
	echo "" >&2
	exit 1
}

########################################################################################################################
# Script

# Parse arguments: <action> [profile] [mode]
action="$1"
profile="$2"
mode="${3:-dind}"  # Default to dind

# Directory where this script lives
script_dir="$(cd -- "$(dirname -- "$0")" && pwd)"

# Project directory (from where this script is executed)
project_dir="$PWD"

# Project name based on current folder
raw_name="$(basename "$PWD")"
safe_name="$(printf '%s' "$raw_name" | tr '[:upper:]' '[:lower:]' | tr -c 'a-z0-9_-' '-')"
proj_name="vsc_${safe_name}"

# Validate action
if [ -z "$action" ]; then
	echo "âœ— Action missing." >&2
	show_help
	exit 1
fi

# Handle 'info' action early (doesn't need mode validation or compose files)
if [ "$action" = "info" ]; then
	show_info "$profile"
	exit 0
fi

# For down/clean actions, auto-detect mode from running container
if [ "$action" = "down" ] || [ "$action" = "clean" ]; then
	# Try to detect mode from running container
	running_container=$(docker ps --filter "name=${proj_name}" --format "{{.Names}}" 2>/dev/null | head -1)

	if [ -n "$running_container" ]; then
		image_name=$(docker inspect "$running_container" --format='{{.Config.Image}}' 2>/dev/null)
		if echo "$image_name" | grep -q "dind"; then
			mode="dind"
		else
			mode="dood"
		fi
	fi
	# If no container running, use default mode or provided mode
fi

# Validate mode
case "$mode" in
	dood|dind)
		# Valid mode
		;;
	*)
		echo "âœ— Unknown mode: $mode" >&2
		echo "   Valid modes: dind, dood" >&2
		show_help
		exit 1
		;;
esac

# Select docker-compose files according to mode
base_compose="$script_dir/docker/docker-compose.yml"
mode_compose="$script_dir/docker/docker-compose.${mode}.yml"

if [ ! -f "$base_compose" ]; then
	echo "âœ— Couldn't find base docker-compose: $base_compose" >&2
	exit 1
fi

if [ ! -f "$mode_compose" ]; then
	echo "âœ— Couldn't find docker-compose for mode '$mode': $mode_compose" >&2
	exit 1
fi

# Compose file arguments for docker compose command
compose_args="-f $base_compose -f $mode_compose"

########################################################################################################################
# Common environment variables

export COMPOSE_PROJECT_NAME="$proj_name"
export PROJECT_DIR="$project_dir"
export WORKSPACE_NAME="$raw_name"  # Mount point will be /<directory-name>
export VSCODE_EXTENSIONS_PROFILE="$profile"
export PROFILE_DIR="$script_dir/profiles/$profile"

########################################################################################################################
# Execution

case "$action" in
	build)
		# Rebuild doesn't care about COMPOSE_PROJECT_NAME as it doesn't create containers or networks
		docker compose $compose_args build
		;;
	up)
		# Check if there are other instances running
		check_running_instances
		#COMPOSE_PROJECT_NAME="$proj_name" \
		#PROJECT_DIR="$project_dir" \
		docker compose $compose_args up
		docker compose $compose_args down
		;;
	upd)
		# Check if there are other instances running
		check_running_instances
		docker compose $compose_args up -d
		;;
	upd-logs)
		# Check if there are other instances running
		check_running_instances
		docker compose $compose_args up -d
		docker compose $compose_args logs -f
		;;
	down)
		docker compose $compose_args down
		;;
	clean)
		docker compose $compose_args down -v
		echo "âœ“ Volumes removed: ${proj_name}_vscode-extensions, ${proj_name}_vscode-config"
		;;
	*)
		echo "âœ— Unknown action: $action" >&2
		show_help
		exit 1
		;;
esac
