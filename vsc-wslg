#!/usr/bin/env bash
set -e

########################################################################################################################
# Functions

check_running_instances() {
	# Search for running vsc_* containers (excluding current one)
	local running=$(docker ps --filter "name=vsc_" --format "{{.Names}}\t{{.Image}}\t{{.Label \"com.docker.compose.project.working_dir\"}}" 2>/dev/null | grep -v "^${proj_name}_")

	if [ -z "$running" ]; then
		return 0  # No instances, continue
	fi

	# There are instance(s) running
	local reset='\033[0m'
	local yellow='\033[33m'
	local cyan='\033[36m'
	local white='\033[97m'
	local green='\033[32m'

	echo "" >&2
	echo -e "${yellow}âš ï¸  There's already a vsc-wslg instance running:${reset}" >&2
	echo "" >&2

	# Show details of each instance
	while IFS=$'\t' read -r container image workdir; do
		local project_name="${container%_vscode_*}"
		local mode_type="DooD"
		if echo "$image" | grep -q "dind"; then
			mode_type="DinD"
		fi
		echo -e "   ${white}Project:${reset}    $project_name (${mode_type})" >&2
		echo -e "   ${white}Container:${reset}  $container" >&2
		[ -n "$workdir" ] && echo -e "   ${white}Workspace:${reset}  $workdir" >&2
		echo "" >&2
	done <<< "$running"

	echo -e "${white}What do you want to do?${reset}" >&2
	echo -e "  ${green}1)${reset} Cancel (keep existing instance)" >&2
	echo -e "  ${green}2)${reset} Close existing instance and open this one" >&2
	echo "" >&2

	read -p "Option [1-2]: " choice

	case "$choice" in
		1)
			echo -e "${cyan}âœ“${reset} Operation cancelled" >&2
			exit 0
			;;
		2)
			echo -e "${cyan}ðŸ›‘${reset} Closing existing instance(s)..." >&2
			# Stop all vsc_* instances
			while IFS=$'\t' read -r container _rest; do
				# Get COMPOSE_PROJECT_NAME from container label
				local project=$(docker inspect "$container" --format='{{index .Config.Labels "com.docker.compose.project"}}' 2>/dev/null)

				# Fallback to parsing if no label
				if [ -z "$project" ]; then
					project="${container%[-_]vscode[-_]*}"
				fi

				echo "   ðŸ” DEBUG: Container name: $container" >&2
				echo "   ðŸ” DEBUG: Extracted project: $project" >&2

				# Determine mode and compose file
				local existing_mode="DooD"
				local image_name=$(docker inspect "$container" --format='{{.Config.Image}}' 2>/dev/null)
				echo "   ðŸ” DEBUG: Image: $image_name" >&2

				if echo "$image_name" | grep -q "dind"; then
					existing_mode="DinD"
				fi
				echo "   ðŸ” DEBUG: Mode: $existing_mode" >&2

				local existing_compose="$script_dir/${existing_mode}/docker-compose.yml"
				echo "   ðŸ” DEBUG: Compose file: $existing_compose" >&2
				echo "   ðŸ” DEBUG: Running: COMPOSE_PROJECT_NAME=$project docker compose -f $existing_compose down" >&2

				# Stop using the correct compose file
				COMPOSE_PROJECT_NAME="$project" docker compose -f "$existing_compose" down 2>&1 | sed 's/^/      /'
				local exit_code=$?
				echo "   ðŸ” DEBUG: Exit code: $exit_code" >&2
			done <<< "$running"
			echo -e "${green}âœ“${reset} Done, proceeding to open new instance..." >&2
			echo "" >&2
			return 0  # Continue with up
			;;
		*)
			echo -e "${yellow}âœ—${reset} Invalid option, cancelling" >&2
			exit 1
			;;
	esac
}

show_help() {
	local reset='\033[0m'
	local cyan='\033[36m'
	local yellow='\033[33m'
	local green='\033[32m'
	local magenta='\033[35m'
	local white='\033[97m'

	echo "" >&2
	echo -e "${white}Usage:${reset} ${cyan}$0${reset} [${magenta}dood${reset}|${magenta}dind${reset}] <action> [profile]" >&2
	echo "" >&2
	echo -e "Containerized VSCode launcher displayed via ${white}WSLg${reset}." >&2
	echo -e "Run from the directory you want to mount as ${yellow}/workspace${reset}." >&2
	echo "" >&2
	echo -e "${white}Mode:${reset}" >&2
	echo -e "  ${magenta}dood${reset}  â†’ Docker-out-of-Docker (uses host's Docker daemon via /var/run/docker.sock)" >&2
	echo -e "  ${magenta}dind${reset}  â†’ Docker-in-Docker (Docker daemon inside container)" >&2
	echo "" >&2
	echo -e "${white}Actions:${reset}" >&2
	echo -e "  ${green}build${reset}      Rebuild the image" >&2
	echo -e "  ${green}up${reset}         Launch VSCode (foreground, down on close)" >&2
	echo -e "  ${green}upd${reset}        Launch VSCode (background)" >&2
	echo -e "  ${green}upd-logs${reset}   Launch VSCode (background + logs)" >&2
	echo -e "  ${green}down${reset}       Stop container" >&2
	echo -e "  ${green}clean${reset}      Stop container and remove volumes" >&2
	echo "" >&2
	echo -e "${white}Available profiles:${reset}" >&2
	for dir in "$script_dir"/profiles/*/; do
		if [ -d "$dir" ]; then
			profile_name=$(basename "$dir")
			echo -e "  ${magenta}${profile_name}${reset}" >&2
		fi
	done
	echo "" >&2
	echo -e "${white}Examples:${reset}" >&2
	echo -e "  ${cyan}$0${reset} ${magenta}dood${reset} ${green}up${reset} symfony" >&2
	echo -e "  ${cyan}$0${reset} ${magenta}dind${reset} ${green}down${reset} symfony" >&2
	echo "" >&2
	exit 1
}

########################################################################################################################
# Script

# Directory from where this script is executed

mode="$1"
action="$2"
#profile="${3:-symfony}"
profile="$3"

# Directory where this script lives
script_dir="$(cd -- "$(dirname -- "$0")" && pwd)"

# Project directory (from where this script is executed)
project_dir="$PWD"

# Project name based on current folder
raw_name="$(basename "$PWD")"
safe_name="$(printf '%s' "$raw_name" | tr '[:upper:]' '[:lower:]' | tr -c 'a-z0-9_-' '-')"
proj_name="vsc_${safe_name}"

# Select docker-compose according to mode
case "$mode" in
	dood)
		compose_file="$script_dir/DooD/docker-compose.yml"
		;;
	dind)
		compose_file="$script_dir/DinD/docker-compose.yml"
		;;
	*)
		echo "âœ— Unknown mode: $mode" >&2
		show_help
		exit 1
		;;
esac

if [ ! -f "$compose_file" ]; then
	echo "âœ— Couldn't find docker-compose for mode '$mode': $compose_file" >&2
	exit 1
fi

if [ -z "$action" ]; then
	echo "âœ— Action missing." >&2
	show_help
	exit 1
fi

########################################################################################################################
# Common environment variables

export COMPOSE_PROJECT_NAME="$proj_name"
export PROJECT_DIR="$project_dir"
export VSCODE_EXTENSIONS_PROFILE="$profile"
export PROFILE_DIR="$script_dir/profiles/$profile"

########################################################################################################################
# Execution

case "$action" in
	build)
		# Rebuild doesn't care about COMPOSE_PROJECT_NAME as it doesn't create containers or networks
		docker compose -f "$compose_file" build
		;;
	up)
		# Check if there are other instances running
		check_running_instances
		#COMPOSE_PROJECT_NAME="$proj_name" \
		#PROJECT_DIR="$project_dir" \
		docker compose -f "$compose_file" up
		docker compose -f "$compose_file" down
		;;
	upd)
		# Check if there are other instances running
		check_running_instances
		docker compose -f "$compose_file" up -d
		;;
	upd-logs)
		# Check if there are other instances running
		check_running_instances
		docker compose -f "$compose_file" up -d
		docker compose -f "$compose_file" logs -f
		;;
	down)
		docker compose -f "$compose_file" down
		;;
	clean)
		docker compose -f "$compose_file" down -v
		echo "âœ“ Volumes removed: ${proj_name}_vscode-extensions, ${proj_name}_vscode-config"
		;;
	*)
		echo "âœ— Unknown action: $action" >&2
		show_help
		exit 1
		;;
esac
