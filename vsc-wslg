#!/usr/bin/env bash
set -e

########################################################################################################################
# Funciones

check_running_instances() {
	# Buscar contenedores vsc_* corriendo (excluyendo el actual)
	local running=$(docker ps --filter "name=vsc_" --format "{{.Names}}\t{{.Image}}\t{{.Label \"com.docker.compose.project.working_dir\"}}" 2>/dev/null | grep -v "^${proj_name}_")

	if [ -z "$running" ]; then
		return 0  # No hay instancias, continuar
	fi

	# Hay instancia(s) corriendo
	local reset='\033[0m'
	local yellow='\033[33m'
	local cyan='\033[36m'
	local white='\033[97m'
	local green='\033[32m'

	echo "" >&2
	echo -e "${yellow}âš ï¸  Ya hay una instancia de vsc-wslg corriendo:${reset}" >&2
	echo "" >&2

	# Mostrar detalles de cada instancia
	while IFS=$'\t' read -r container image workdir; do
		local project_name="${container%_vscode_*}"
		local mode_type="DooD"
		if echo "$image" | grep -q "dind"; then
			mode_type="DinD"
		fi
		echo -e "   ${white}Proyecto:${reset}   $project_name (${mode_type})" >&2
		echo -e "   ${white}Contenedor:${reset} $container" >&2
		[ -n "$workdir" ] && echo -e "   ${white}Workspace:${reset}  $workdir" >&2
		echo "" >&2
	done <<< "$running"

	echo -e "${white}Â¿QuÃ© quieres hacer?${reset}" >&2
	echo -e "  ${green}1)${reset} Cancelar (mantener la instancia existente)" >&2
	echo -e "  ${green}2)${reset} Cerrar la instancia existente y abrir esta" >&2
	echo "" >&2

	read -p "OpciÃ³n [1-2]: " choice

	case "$choice" in
		1)
			echo -e "${cyan}âœ“${reset} OperaciÃ³n cancelada" >&2
			exit 0
			;;
		2)
			echo -e "${cyan}ðŸ›‘${reset} Cerrando instancia(s) existente(s)..." >&2
			# Bajar todas las instancias vsc_*
			while IFS=$'\t' read -r container _rest; do
				# Obtener el COMPOSE_PROJECT_NAME del label del contenedor
				local project=$(docker inspect "$container" --format='{{index .Config.Labels "com.docker.compose.project"}}' 2>/dev/null)

				# Fallback al parsing si no hay label
				if [ -z "$project" ]; then
					project="${container%[-_]vscode[-_]*}"
				fi

				echo "   ðŸ” DEBUG: Container name: $container" >&2
				echo "   ðŸ” DEBUG: Extracted project: $project" >&2

				# Determinar el modo y compose file
				local existing_mode="DooD"
				local image_name=$(docker inspect "$container" --format='{{.Config.Image}}' 2>/dev/null)
				echo "   ðŸ” DEBUG: Image: $image_name" >&2

				if echo "$image_name" | grep -q "dind"; then
					existing_mode="DinD"
				fi
				echo "   ðŸ” DEBUG: Mode: $existing_mode" >&2

				local existing_compose="$script_dir/${existing_mode}/docker-compose.yml"
				echo "   ðŸ” DEBUG: Compose file: $existing_compose" >&2
				echo "   ðŸ” DEBUG: Running: COMPOSE_PROJECT_NAME=$project docker compose -f $existing_compose down" >&2

				# Bajar usando el compose file correcto
				COMPOSE_PROJECT_NAME="$project" docker compose -f "$existing_compose" down 2>&1 | sed 's/^/      /'
				local exit_code=$?
				echo "   ðŸ” DEBUG: Exit code: $exit_code" >&2
			done <<< "$running"
			echo -e "${green}âœ“${reset} Listo, procediendo a abrir nueva instancia..." >&2
			echo "" >&2
			return 0  # Continuar con el up
			;;
		*)
			echo -e "${yellow}âœ—${reset} OpciÃ³n invÃ¡lida, cancelando" >&2
			exit 1
			;;
	esac
}

show_help() {
	local reset='\033[0m'
	local cyan='\033[36m'
	local yellow='\033[33m'
	local green='\033[32m'
	local magenta='\033[35m'
	local white='\033[97m'

	echo "" >&2
	echo -e "${white}Uso:${reset} ${cyan}$0${reset} [${magenta}dood${reset}|${magenta}dind${reset}] <acciÃ³n> [perfil]" >&2
	echo "" >&2
	echo -e "Lanzador de VSCode containerizado mostrado via ${white}WSLg${reset}." >&2
	echo -e "Ejecutar desde el directorio que se desee montar como ${yellow}/workspace${reset}." >&2
	echo "" >&2
	echo -e "${white}Modo:${reset}" >&2
	echo -e "  ${magenta}dood${reset}  â†’ Docker-out-of-Docker (usa el daemon de Docker del host via /var/run/docker.sock)" >&2
	echo -e "  ${magenta}dind${reset}  â†’ Docker-in-Docker (daemon Docker dentro del contenedor)" >&2
	echo "" >&2
	echo -e "${white}Acciones:${reset}" >&2
	echo -e "  ${green}build${reset}      Reconstruir la imagen" >&2
	echo -e "  ${green}up${reset}         Lanzar VSCode (foreground, down al cerrar)" >&2
	echo -e "  ${green}upd${reset}        Lanzar VSCode (background)" >&2
	echo -e "  ${green}upd-logs${reset}   Lanzar VSCode (background + logs)" >&2
	echo -e "  ${green}down${reset}       Parar contenedor" >&2
	echo -e "  ${green}clean${reset}      Parar contenedor y borrar volÃºmenes" >&2
	echo "" >&2
	echo -e "${white}Perfiles disponibles:${reset}" >&2
	for dir in "$script_dir"/profiles/*/; do
		if [ -d "$dir" ]; then
			profile_name=$(basename "$dir")
			echo -e "  ${magenta}${profile_name}${reset}" >&2
		fi
	done
	echo "" >&2
	echo -e "${white}Ejemplos:${reset}" >&2
	echo -e "  ${cyan}$0${reset} ${magenta}dood${reset} ${green}up${reset} symfony" >&2
	echo -e "  ${cyan}$0${reset} ${magenta}dind${reset} ${green}down${reset} symfony" >&2
	echo "" >&2
	exit 1
}

########################################################################################################################
# Script

# Directorio desde donde se ejecuta este script

mode="$1"
action="$2"
#profile="${3:-symfony}"
profile="$3"

# Directorio donde vive este script
script_dir="$(cd -- "$(dirname -- "$0")" && pwd)"

# Directorio del proyecto (desde donde se ejecuta este script)
project_dir="$PWD"

# Nombre del proyecto segÃºn la carpeta actual
raw_name="$(basename "$PWD")"
safe_name="$(printf '%s' "$raw_name" | tr '[:upper:]' '[:lower:]' | tr -c 'a-z0-9_-' '-')"
proj_name="vsc_${safe_name}"

# SelecciÃ³n del docker-compose segÃºn modo
case "$mode" in
	dood)
		compose_file="$script_dir/DooD/docker-compose.yml"
		;;
	dind)
		compose_file="$script_dir/DinD/docker-compose.yml"
		;;
	*)
		echo "âœ— Modo desconocido: $mode" >&2
		show_help
		exit 1
		;;
esac

if [ ! -f "$compose_file" ]; then
	echo "âœ— No se encontrÃ³ el docker-compose para el modo '$mode': $compose_file" >&2
	exit 1
fi

if [ -z "$action" ]; then
	echo "âœ— Falta la acciÃ³n." >&2
	show_help
	exit 1
fi

########################################################################################################################
# Variables de entorno comunes

export COMPOSE_PROJECT_NAME="$proj_name"
export PROJECT_DIR="$project_dir"
export VSCODE_EXTENSIONS_PROFILE="$profile"
export PROFILE_DIR="$script_dir/profiles/$profile"

########################################################################################################################
# EjecuciÃ³n

case "$action" in
	build)
		# a rebuild le da igual el COMPOSE_PROJECT_NAME pq no llega a crear contenedores ni redes
		docker compose -f "$compose_file" build
		;;
	up)
		# Verificar si hay otras instancias corriendo
		check_running_instances
		#COMPOSE_PROJECT_NAME="$proj_name" \
		#PROJECT_DIR="$project_dir" \
		docker compose -f "$compose_file" up
		docker compose -f "$compose_file" down
		;;
	upd)
		# Verificar si hay otras instancias corriendo
		check_running_instances
		docker compose -f "$compose_file" up -d
		;;
	upd-logs)
		# Verificar si hay otras instancias corriendo
		check_running_instances
		docker compose -f "$compose_file" up -d
		docker compose -f "$compose_file" logs -f
		;;
	down)
		docker compose -f "$compose_file" down
		;;
	clean)
		docker compose -f "$compose_file" down -v
		echo "âœ“ VolÃºmenes eliminados: ${proj_name}_vscode-extensions, ${proj_name}_vscode-config"
		;;
	*)
		echo "âœ— AcciÃ³n desconocida: $action" >&2
		show_help
		exit 1
		;;
esac
