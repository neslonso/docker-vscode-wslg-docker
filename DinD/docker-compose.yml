services:
  vscode:
    build:
      context: ..
      dockerfile: docker/Dockerfile.base
      args:
        INSTALL_DOCKER_DAEMON: "true"
        ENTRYPOINT_MODE: "DinD"
    image: vscode-wslg-dind
    shm_size: '1gb' # Más memoria compartida
    privileged: true # Requerido para DinD
    environment:
      - DISPLAY
      - WAYLAND_DISPLAY
      - XDG_RUNTIME_DIR=/mnt/wslg/runtime-dir
      - PULSE_SERVER
      - VSCODE_EXTENSIONS_PROFILE
      #- ELECTRON_OZONE_PLATFORM_HINT=x11 # forzar X11
      - BROWSER=surf
    volumes:
      # Workspace del proyecto
      - ${PROJECT_DIR}:/workspace

      # Perfil montado en home (solo si está definido)
      - ${PROFILE_DIR}:/home/dev/vsc-wslg-${VSCODE_EXTENSIONS_PROFILE}-profile:ro

      # Volúmenes WSLg para GUI
      - /tmp/.X11-unix:/tmp/.X11-unix
      - /mnt/wslg:/mnt/wslg

      # Persistencia de Docker (imágenes, capas, contenedores)
      # Aislado por proyecto para evitar conflictos
      - dind-data:/var/lib/docker

      # Persistencia de extensiones y configuración
      # COMPARTIDOS entre TODOS los contenedores para permitir múltiples ventanas VSCode
      # Similar a cómo Windows comparte %APPDATA%\Code entre todas las ventanas
      - ${HOME}/.vscode-wslg/extensions:/home/dev/.vscode
      - ${HOME}/.vscode-wslg/config:/home/dev/.config/Code
    restart: "no"

volumes:
  # Volumen de Docker daemon (aislado por proyecto)
  # El nombre completo será: {COMPOSE_PROJECT_NAME}_dind-data
  dind-data:
